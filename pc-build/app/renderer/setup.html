<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–ª–∞—Å—Ç–µ–π OCR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #050511;
            --bg-secondary: #0a0a1f;
            --bg-card: rgba(15, 15, 35, 0.95);
            --border-color: rgba(139, 92, 246, 0.2);
            --text-primary: #f0f0f5;
            --text-secondary: #a0a0b8;
            --accent-purple: #8B5CF6;
            --accent-blue: #3B82F6;
            --accent-pink: #EC4899;
            --success: #10B981;
            --error: #EF4444;
            --warning: #8B5CF6;
            --glass: rgba(255, 255, 255, 0.02);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: transparent;
            color: var(--text-primary);
            overflow: hidden;
            cursor: crosshair;
            user-select: none;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 17, 0.85);
            backdrop-filter: blur(0.1px);
            pointer-events: none;
        }

        /* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ */
        .instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, 
                rgba(20, 20, 35, 0.98), 
                rgba(15, 15, 30, 0.98)
            );
            backdrop-filter: blur(20px);
            padding: 50px;
            border-radius: 30px;
            text-align: center;
            max-width: 800px;
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.8),
                0 0 100px rgba(139, 92, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            pointer-events: all;
            animation: modal-appear 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modal-appear {
            from {
                opacity: 0;
                transform: translate(-50%, -40%) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .instructions::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                var(--accent-purple), 
                var(--accent-pink), 
                var(--accent-blue), 
                var(--accent-purple)
            );
            border-radius: 30px;
            opacity: 0.3;
            z-index: -1;
            /* animation: gradient-rotate 4s linear infinite; */ /* –û—Ç–∫–ª—é—á–µ–Ω–æ */
        }

        @keyframes gradient-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .instructions h2 {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 40px rgba(139, 92, 246, 0.5);
        }

        .step {
            background: var(--bg-primary);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            text-align: left;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 
                inset 2px 2px 5px rgba(0, 0, 0, 0.5),
                inset -2px -2px 5px rgba(255, 255, 255, 0.02);
        }

        .step::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .step:hover::before {
            left: 100%;
        }

        .step:hover {
            transform: translateY(-2px);
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: 
                0 8px 25px rgba(139, 92, 246, 0.2),
                inset 2px 2px 5px rgba(0, 0, 0, 0.5),
                inset -2px -2px 5px rgba(255, 255, 255, 0.02);
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            border-radius: 50%;
            text-align: center;
            margin-right: 20px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.5);
        }

        .step-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        .step-description {
            color: var(--text-secondary);
            font-size: 15px;
            margin-left: 55px;
            line-height: 1.5;
        }

        .mode-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mode-badge.fast {
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.2), 
                rgba(59, 130, 246, 0.2)
            );
            color: var(--accent-blue);
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .mode-badge.precise {
            background: linear-gradient(135deg, 
                rgba(118, 75, 162, 0.2), 
                rgba(236, 72, 153, 0.2)
            );
            color: var(--accent-pink);
            border: 1px solid rgba(236, 72, 153, 0.3);
        }

        .mode-badge.both {
            background: linear-gradient(135deg, 
                rgba(16, 185, 129, 0.2), 
                rgba(5, 150, 105, 0.2)
            );
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .button-group {
            display: flex;
            gap: 20px;
            margin-top: 40px;
            justify-content: center;
        }

        .button {
            padding: 14px 35px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .button.primary {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            color: white;
            box-shadow: 
                0 8px 25px rgba(139, 92, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .button.primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 12px 35px rgba(139, 92, 246, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .button.secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .button.secondary:hover {
            background: rgba(40, 40, 60, 0.8);
            border-color: rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–¥–µ–ª–µ–Ω–∏–∏ */
        .selection-info {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, 
                rgba(20, 20, 35, 0.98), 
                rgba(15, 15, 30, 0.98)
            );
            backdrop-filter: blur(20px);
            padding: 25px 50px;
            border-radius: 20px;
            display: none;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.8),
                0 0 60px rgba(139, 92, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .selection-info.active {
            display: block;
        }

        .region-label {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .region-label.trigger {
            background: linear-gradient(135deg, var(--success), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .region-label.normal {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .region-label.precise {
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .region-hint {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* –ë–æ–∫—Å—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è */
        .selection-box {
            position: absolute;
            border: 3px solid;
            pointer-events: none;
            transition: all 0.1s ease;
            animation: selection-glow 2s ease-in-out infinite;
        }

        @keyframes selection-glow {
            0%, 100% {
                opacity: 0.8;
                filter: drop-shadow(0 0 10px currentColor);
            }
            50% {
                opacity: 1;
                filter: drop-shadow(0 0 20px currentColor);
            }
        }

        .selection-box.trigger {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .selection-box.normal {
            border-color: var(--accent-blue);
            background: rgba(102, 126, 234, 0.1);
        }

        .selection-box.precise {
            border-color: var(--accent-pink);
            background: rgba(236, 72, 153, 0.1);
        }

        .selection-box.preview {
            border-style: solid;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 0.6;
                transform: scale(1);
            }
            50% { 
                opacity: 0.9;
                transform: scale(1.01);
            }
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
        .preview-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, 
                rgba(20, 20, 35, 0.98), 
                rgba(15, 15, 30, 0.98)
            );
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 30px;
            display: none;
            max-width: 1000px;
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.8),
                0 0 100px rgba(139, 92, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            animation: modal-appear 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .preview-modal.active {
            display: block;
        }

        .preview-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
            background: linear-gradient(135deg, var(--text-primary), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .preview-images {
            display: flex;
            gap: 25px;
            margin-bottom: 30px;
        }

        .preview-item {
            flex: 1;
            text-align: center;
        }

        .preview-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .preview-image {
            max-width: 100%;
            border: 2px solid var(--border-color);
            border-radius: 15px;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .preview-image:hover {
            transform: scale(1.05);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 
                0 15px 40px rgba(139, 92, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .error-message {
            background: linear-gradient(135deg, 
                rgba(239, 68, 68, 0.1), 
                rgba(220, 38, 38, 0.1)
            );
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--error);
            padding: 18px;
            border-radius: 15px;
            margin-top: 25px;
            text-align: center;
            display: none;
            font-weight: 500;
            box-shadow: 
                0 4px 15px rgba(239, 68, 68, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞ */
        .success-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            animation: success-burst 1.2s ease-out;
            pointer-events: none;
            filter: drop-shadow(0 0 40px var(--success));
        }

        @keyframes success-burst {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.3);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.8);
            }
        }

        /* –ö—É—Ä—Å–æ—Ä –∫–∞—Å—Ç–æ–º–Ω—ã–π */
        .custom-cursor {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-purple);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            transition: all 0.1s ease;
            transform: translate(-50%, -50%);
        }

        .custom-cursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: var(--accent-purple);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div class="overlay"></div>
    <div class="custom-cursor" id="custom-cursor"></div>

    <div class="instructions" id="instructions">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–ª–∞—Å—Ç–µ–π OCR</h2>
        
        <div class="step">
            <div class="step-title">
                <span class="step-number">1</span>
                –û–±–ª–∞—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–∞ <span class="mode-badge both">–û–±–∞ —Ä–µ–∂–∏–º–∞</span>
            </div>
            <div class="step-description">
                –í—ã–¥–µ–ª–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å, –≥–¥–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å–∏–Ω–∏–π —ç–∫—Ä–∞–Ω "VS" –ø–µ—Ä–µ–¥ –±–æ–µ–º. 
                –≠—Ç–∞ –æ–±–ª–∞—Å—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞—á–∞–ª–∞ –º–∞—Ç—á–∞.
            </div>
        </div>

        <div class="step">
            <div class="step-title">
                <span class="step-number">2</span>
                –ë—ã—Å—Ç—Ä–∞—è –æ–±–ª–∞—Å—Ç—å <span class="mode-badge fast">–ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º</span>
            </div>
            <div class="step-description">
                –ù–µ–±–æ–ª—å—à–∞—è –æ–±–ª–∞—Å—Ç—å —Å –Ω–∏–∫–æ–º –∏ –º–µ–¥–∞–ª—è–º–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞. 
                –ü–æ—è–≤–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —ç–∫—Ä–∞–Ω–∞ VS –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞.
            </div>
        </div>

        <div class="step">
            <div class="step-title">
                <span class="step-number">3</span>
                –¢–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å <span class="mode-badge precise">–¢–æ—á–Ω—ã–π —Ä–µ–∂–∏–º</span>
            </div>
            <div class="step-description">
                –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –≤–∫–ª—é—á–∞—é—â–∞—è –Ω–∏–∫, –º–µ–¥–∞–ª–∏ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞. 
                –ü–æ—è–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ 3-4 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞.
            </div>
        </div>
        
        <div class="button-group">
            <button class="button primary" onclick="startSetup()">–ù–∞—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É</button>
            <button class="button secondary" onclick="cancelSetup()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div class="selection-info" id="selection-info">
        <div class="region-label trigger" id="region-label">–í—ã–¥–µ–ª–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–∞</div>
        <div class="region-hint">–ù–∞–∂–º–∏—Ç–µ –∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –æ–±–ª–∞—Å—Ç–∏</div>
    </div>

    <div class="preview-modal" id="preview-modal">
        <h3 class="preview-title">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π</h3>
        <div class="preview-images">
            <div class="preview-item">
                <div class="preview-label">–û–±–ª–∞—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–∞</div>
                <img id="trigger-preview" class="preview-image" />
            </div>
            <div class="preview-item">
                <div class="preview-label">–ë—ã—Å—Ç—Ä–∞—è –æ–±–ª–∞—Å—Ç—å</div>
                <img id="normal-preview" class="preview-image" />
            </div>
            <div class="preview-item">
                <div class="preview-label">–¢–æ—á–Ω–∞—è –æ–±–ª–∞—Å—Ç—å</div>
                <img id="precise-preview" class="preview-image" />
            </div>
        </div>
        <div class="button-group">
            <button class="button primary" onclick="saveRegions()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="button secondary" onclick="retrySetup()">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        </div>
        <div class="error-message" id="error-message"></div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const customCursor = document.getElementById('custom-cursor');
        let screenshot = null;
        let isSelecting = false;
        let currentRegion = 'trigger_area';
        let startX, startY, endX, endY;
        let regions = {
            trigger_area: null,
            normal_data_area: null,
            precise_data_area: null,
            screen_resolution: {
                width: 0,  // –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
                height: 0  // –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
            }
        };
        
        // üÜï –≠–¢–ê–ü 1.1: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≥—Ä–∞–Ω–∏—Ü –æ–∫–Ω–∞
        let windowBounds = null;
        let setupMode = 'screen';
        let scaleFactor = 1;
        let setupContext = null;  // üÜï –ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–æ–∫–Ω–æ –∏–ª–∏ —ç–∫—Ä–∞–Ω)

        // –ö–∞—Å—Ç–æ–º–Ω—ã–π –∫—É—Ä—Å–æ—Ä
        document.addEventListener('mousemove', (e) => {
            customCursor.style.left = e.clientX + 'px';
            customCursor.style.top = e.clientY + 'px';
        });

        // –ü–æ–ª—É—á–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç –æ—Ç main –ø—Ä–æ—Ü–µ—Å—Å–∞
        window.electronAPI.on('screenshot', (screenshotData) => {
            screenshot = new Image();
            screenshot.onload = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                ctx.drawImage(screenshot, 0, 0, canvas.width, canvas.height);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º screen_resolution —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
                regions.screen_resolution = {
                    width: screenshot.naturalWidth,
                    height: screenshot.naturalHeight
                };
                console.log('Physical screen resolution:', regions.screen_resolution);
            };
            screenshot.src = screenshotData;
        });
        
        // üÜï –≠–¢–ê–ü 2.1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        window.electronAPI.on('setup-context', (contextData) => {
            setupContext = contextData;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–ª—è –æ–∫–æ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
            if (setupContext && setupContext.mode === 'window') {
                updateUIForWindowMode(setupContext);
            }
        });
        
        // üÜï –≠–¢–ê–ü 1.1: –ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü –æ–∫–Ω–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        window.electronAPI.on('window-bounds', (boundsData) => {
            windowBounds = boundsData.bounds;
            setupMode = boundsData.mode;
            scaleFactor = boundsData.scaleFactor;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –æ–∫–æ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
            if (setupMode === 'window' && windowBounds) {
                updateInstructionsForWindowMode();
            }
        });

        function startSetup() {
            document.getElementById('instructions').style.display = 'none';
            document.getElementById('selection-info').classList.add('active');
            canvas.style.cursor = 'crosshair';
            customCursor.style.display = 'block';
        }

        function cancelSetup() {
            window.close();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è –æ–±–ª–∞—Å—Ç–µ–π
        canvas.addEventListener('mousedown', (e) => {
            if (!regions.trigger_area || !regions.normal_data_area || !regions.precise_data_area) {
                isSelecting = true;
                startX = e.clientX;
                startY = e.clientY;
                
                // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–π –æ–±–ª–∞—Å—Ç–∏
                const existingBoxes = document.querySelectorAll(`.selection-box:not(.preview)`);
                existingBoxes.forEach(box => {
                    const isTrigger = box.classList.contains('trigger');
                    const isNormal = box.classList.contains('normal');
                    const isPrecise = box.classList.contains('precise');
                    
                    if ((currentRegion === 'trigger_area' && isTrigger) ||
                        (currentRegion === 'normal_data_area' && isNormal) ||
                        (currentRegion === 'precise_data_area' && isPrecise)) {
                        box.remove();
                    }
                });
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isSelecting) {
                endX = e.clientX;
                endY = e.clientY;
                drawSelectionBox();
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (isSelecting) {
                isSelecting = false;
                endX = e.clientX;
                endY = e.clientY;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                const x = Math.min(startX, endX);
                const y = Math.min(startY, endY);
                const width = Math.abs(endX - startX);
                const height = Math.abs(endY - startY);
                
                if (width > 10 && height > 10) {
                    // üÜï –≠–¢–ê–ü 1.1: –í–∞–ª–∏–¥–∞—Ü–∏—è –≥—Ä–∞–Ω–∏—Ü –æ–±–ª–∞—Å—Ç–∏ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
                    const validationResult = validateRegionBounds({ x, y, width, height });
                    if (!validationResult.valid) {
                        showValidationError(validationResult.error);
                        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏
                    }
                    
                    regions[currentRegion] = { x, y, width, height };
                    
                    // –°–æ–∑–¥–∞—ë–º –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é —Ä–∞–º–∫—É
                    const permanentBox = document.createElement('div');
                    permanentBox.className = 'selection-box permanent';
                    
                    if (currentRegion === 'trigger_area') {
                        permanentBox.classList.add('trigger');
                        currentRegion = 'normal_data_area';
                        document.getElementById('region-label').textContent = '–í—ã–¥–µ–ª–∏—Ç–µ –±—ã—Å—Ç—Ä—É—é –æ–±–ª–∞—Å—Ç—å';
                        document.getElementById('region-label').className = 'region-label normal';
                    } else if (currentRegion === 'normal_data_area') {
                        permanentBox.classList.add('normal');
                        currentRegion = 'precise_data_area';
                        document.getElementById('region-label').textContent = '–í—ã–¥–µ–ª–∏—Ç–µ —Ç–æ—á–Ω—É—é –æ–±–ª–∞—Å—Ç—å';
                        document.getElementById('region-label').className = 'region-label precise';
                    } else if (currentRegion === 'precise_data_area') {
                        permanentBox.classList.add('precise');
                        showPreview();
                    }
                    
                    permanentBox.style.left = x + 'px';
                    permanentBox.style.top = y + 'px';
                    permanentBox.style.width = width + 'px';
                    permanentBox.style.height = height + 'px';
                    document.body.appendChild(permanentBox);
                }
            }
        });

        function drawSelectionBox() {
            // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ä–∞–º–∫—É
            const tempBox = document.querySelector('.selection-box.temp');
            if (tempBox) tempBox.remove();
            
            const box = document.createElement('div');
            box.className = 'selection-box temp';
            
            if (currentRegion === 'trigger_area') {
                box.classList.add('trigger');
            } else if (currentRegion === 'normal_data_area') {
                box.classList.add('normal');
            } else if (currentRegion === 'precise_data_area') {
                box.classList.add('precise');
            }
            
            box.style.left = Math.min(startX, endX) + 'px';
            box.style.top = Math.min(startY, endY) + 'px';
            box.style.width = Math.abs(endX - startX) + 'px';
            box.style.height = Math.abs(endY - startY) + 'px';
            document.body.appendChild(box);
        }

        function showPreview() {
            document.getElementById('selection-info').classList.remove('active');
            customCursor.style.display = 'none';
            
            // –°–æ–∑–¥–∞—ë–º –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            const createPreview = (region, elementId) => {
                const previewCanvas = document.createElement('canvas');
                const previewCtx = previewCanvas.getContext('2d');
                previewCanvas.width = region.width;
                previewCanvas.height = region.height;
                previewCtx.drawImage(
                    screenshot,
                    region.x * (screenshot.width / canvas.width),
                    region.y * (screenshot.height / canvas.height),
                    region.width * (screenshot.width / canvas.width),
                    region.height * (screenshot.height / canvas.height),
                    0, 0,
                    region.width,
                    region.height
                );
                document.getElementById(elementId).src = previewCanvas.toDataURL();
            };
            
            createPreview(regions.trigger_area, 'trigger-preview');
            createPreview(regions.normal_data_area, 'normal-preview');
            createPreview(regions.precise_data_area, 'precise-preview');
            
            document.getElementById('preview-modal').classList.add('active');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            showPreviewBoxes();
        }

        function showPreviewBoxes() {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏
            document.querySelectorAll('.selection-box.temp').forEach(box => box.remove());
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å preview –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ä–∞–º–∫–∞–º
            document.querySelectorAll('.selection-box.permanent').forEach(box => {
                box.classList.add('preview');
            });
        }

        function retrySetup() {
            // –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫
            regions.trigger_area = null;
            regions.normal_data_area = null;
            regions.precise_data_area = null;
            currentRegion = 'trigger_area';
            
            document.getElementById('preview-modal').classList.remove('active');
            document.getElementById('selection-info').classList.add('active');
            document.getElementById('region-label').textContent = '–í—ã–¥–µ–ª–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–∞';
            document.getElementById('region-label').className = 'region-label trigger';
            customCursor.style.display = 'block';
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ä–∞–º–∫–∏
            document.querySelectorAll('.selection-box').forEach(box => box.remove());
        }

        async function saveRegions() {
            const saveButton = event.target;
            saveButton.disabled = true;
            saveButton.textContent = '–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è...';
            
            try {
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞
                const scaleX = screenshot.width / canvas.width;
                const scaleY = screenshot.height / canvas.height;
                
                // üéØ –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞
                console.log('üîç –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –æ–±–ª–∞—Å—Ç–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞...');
                
                // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è trigger_area
                const triggerProfile = await createPersonalTriggerProfile(
                    regions.trigger_area, 
                    scaleX, 
                    scaleY
                );
                
                if (!triggerProfile.success) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ${triggerProfile.error}`);
                }
                
                console.log('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω:', triggerProfile);
                
                saveButton.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                
                const finalRegions = {
                    trigger_area: {
                        x: Math.round(regions.trigger_area.x * scaleX),
                        y: Math.round(regions.trigger_area.y * scaleY),
                        width: Math.round(regions.trigger_area.width * scaleX),
                        height: Math.round(regions.trigger_area.height * scaleY),
                        // üÜï –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
                        color_palette: triggerProfile.color_palette,
                        template_base64: triggerProfile.template_base64,
                        created_at: new Date().toISOString()
                    },
                    normal_data_area: {
                        x: Math.round(regions.normal_data_area.x * scaleX),
                        y: Math.round(regions.normal_data_area.y * scaleY),
                        width: Math.round(regions.normal_data_area.width * scaleX),
                        height: Math.round(regions.normal_data_area.height * scaleY)
                    },
                    precise_data_area: {
                        x: Math.round(regions.precise_data_area.x * scaleX),
                        y: Math.round(regions.precise_data_area.y * scaleY),
                        width: Math.round(regions.precise_data_area.width * scaleX),
                        height: Math.round(regions.precise_data_area.height * scaleY)
                    },
                    screen_resolution: regions.screen_resolution
                };
                
                const result = await window.electronAPI.ocr.saveRegions(finalRegions);
                
                if (result.success) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —É—Å–ø–µ—Ö–∞
                    const successIcon = document.createElement('div');
                    successIcon.className = 'success-animation';
                    successIcon.textContent = '‚úÖ';
                    document.body.appendChild(successIcon);
                    
                    setTimeout(() => {
                        window.close();
                    }, 1000);
                } else {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±–ª–∞—Å—Ç–µ–π');
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–≥–∏–æ–Ω–æ–≤:', error);
                document.getElementById('error-message').textContent = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                document.getElementById('error-message').style.display = 'block';
                saveButton.disabled = false;
                saveButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            }
        }

        /**
         * –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∏–∑ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
         * @param {Object} triggerArea - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–±–ª–∞—Å—Ç–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞ (canvas –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
         * @param {number} scaleX - –ú–∞—Å—à—Ç–∞–± –ø–æ X –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
         * @param {number} scaleY - –ú–∞—Å—à—Ç–∞–± –ø–æ Y –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
         * @returns {Object} –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ {success, color_palette, template_base64, error}
         */
        async function createPersonalTriggerProfile(triggerArea, scaleX, scaleY) {
            try {
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas –¥–ª—è –≤—ã—Ä–µ–∑–∫–∏ –æ–±–ª–∞—Å—Ç–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                // –†–∞–∑–º–µ—Ä—ã –æ–±–ª–∞—Å—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö —ç–∫—Ä–∞–Ω–∞
                const realWidth = Math.round(triggerArea.width * scaleX);
                const realHeight = Math.round(triggerArea.height * scaleY);
                const realX = Math.round(triggerArea.x * scaleX);
                const realY = Math.round(triggerArea.y * scaleY);
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ canvas
                tempCanvas.width = realWidth;
                tempCanvas.height = realHeight;
                
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
                const img = new Image();
                const imagePromise = new Promise((resolve, reject) => {
                    img.onload = () => resolve(img);
                    img.onerror = () => reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç'));
                });
                
                img.src = canvas.toDataURL();
                await imagePromise;
                
                // –í—ã—Ä–µ–∑–∞–µ–º –æ–±–ª–∞—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                tempCtx.drawImage(
                    img,
                    triggerArea.x, triggerArea.y, triggerArea.width, triggerArea.height, // source
                    0, 0, realWidth, realHeight // destination
                );
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ Python
                const triggerImageBase64 = tempCanvas.toDataURL('image/png').split(',')[1];
                
                console.log(`üì∏ –í—ã—Ä–µ–∑–∞–Ω–∞ –æ–±–ª–∞—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–∞: ${realWidth}x${realHeight} –ø–∏–∫—Å–µ–ª–µ–π`);
                
                // –í—ã–∑—ã–≤–∞–µ–º Python –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ IPC
                const profileResult = await window.electronAPI.ocr.analyzeProfile({
                    imageData: triggerImageBase64,
                    size: {
                        width: realWidth,
                        height: realHeight
                    }
                });
                
                if (!profileResult.success) {
                    throw new Error(profileResult.error || '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ—Ñ–∏–ª—è');
                }
                
                return {
                    success: true,
                    color_palette: profileResult.color_palette,
                    template_base64: profileResult.template_base64,
                    analysis_info: {
                        image_size: `${realWidth}x${realHeight}`,
                        colors_found: profileResult.color_palette.length
                    }
                };
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                return {
                    success: false,
                    error: error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞'
                };
            }
        }

        // üÜï –≠–¢–ê–ü 1.1: –§—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≥—Ä–∞–Ω–∏—Ü –æ–∫–Ω–∞
        function validateRegionBounds(region) {
            if (!windowBounds || setupMode !== 'window') {
                return { valid: true }; // –î–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–µ—Ç
            }
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã canvas –≤ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –ø–∏–∫—Å–µ–ª–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å bounds
            const scaleX = screenshot.naturalWidth / canvas.width;
            const scaleY = screenshot.naturalHeight / canvas.height;
            
            const physicalRegion = {
                x: Math.round(region.x * scaleX),
                y: Math.round(region.y * scaleY),
                width: Math.round(region.width * scaleX),
                height: Math.round(region.height * scaleY)
            };
            
            const withinBounds = physicalRegion.x >= windowBounds.x && 
                                physicalRegion.y >= windowBounds.y &&
                                physicalRegion.x + physicalRegion.width <= windowBounds.x + windowBounds.width &&
                                physicalRegion.y + physicalRegion.height <= windowBounds.y + windowBounds.height;
            
            if (!withinBounds) {
                return {
                    valid: false,
                    error: '–û–±–ª–∞—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞'
                };
            }
            
            return { valid: true };
        }
        
        function showValidationError(errorMessage) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            const errorDiv = document.createElement('div');
            errorDiv.className = 'validation-error';
            errorDiv.style.cssText = `
                position: absolute;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
                color: white;
                padding: 15px 30px;
                border-radius: 10px;
                font-weight: 600;
                box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
                z-index: 10000;
                animation: errorSlide 0.3s ease-out;
            `;
            errorDiv.textContent = errorMessage;
            
            document.body.appendChild(errorDiv);
            
            // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 3000);
        }
        
        function updateInstructionsForWindowMode() {
            const instructionsTitle = document.querySelector('.instructions h2');
            if (instructionsTitle && setupMode === 'window') {
                instructionsTitle.textContent = '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–ª–∞—Å—Ç–µ–π OCR (–û–∫–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º)';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, —á—Ç–æ –æ–±–ª–∞—Å—Ç–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –æ–∫–Ω–æ–º
                const existingNote = document.getElementById('window-mode-note');
                if (!existingNote) {
                    const noteDiv = document.createElement('div');
                    noteDiv.id = 'window-mode-note';
                    noteDiv.style.cssText = `
                        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
                        border: 1px solid rgba(59, 130, 246, 0.3);
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 20px;
                        color: var(--accent-blue);
                        font-size: 14px;
                        text-align: center;
                    `;
                    noteDiv.innerHTML = 'üìç –û–±–ª–∞—Å—Ç–∏ –º–æ–∂–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞';
                    
                    const instructions = document.getElementById('instructions');
                    const firstStep = instructions.querySelector('.step');
                    instructions.insertBefore(noteDiv, firstStep);
                }
            }
        }
        
        // üÜï –≠–¢–ê–ü 2.1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–ª—è –æ–∫–æ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        function updateUIForWindowMode(context) {
            console.log('ü™ü –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–ª—è –æ–∫–æ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞:', context);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const instructionsTitle = document.querySelector('.instructions h2');
            if (instructionsTitle) {
                instructionsTitle.innerHTML = `
                    ü™ü –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–ª–∞—Å—Ç–µ–π OCR<br>
                    <small style="color: var(--accent-blue); font-size: 0.8em;">–û–∫–Ω–æ: ${context.targetWindow?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</small>
                `;
            }
            
            // –°–æ–∑–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å
            createWindowInfoPanel(context.targetWindow);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            updateInstructionsForWindowMode();
        }
        
        // üÜï –≠–¢–ê–ü 2.1: –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏ –æ –æ–∫–Ω–µ
        function createWindowInfoPanel(windowInfo) {
            if (!windowInfo) return;
            
            // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–∞–Ω–µ–ª—å
            const existingPanel = document.getElementById('window-info-panel');
            if (existingPanel) {
                existingPanel.remove();
            }
            
            const panel = document.createElement('div');
            panel.id = 'window-info-panel';
            panel.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 15px;
                padding: 20px;
                min-width: 280px;
                backdrop-filter: blur(10px);
                z-index: 1000;
                color: var(--text-primary);
                font-family: inherit;
                box-shadow: var(--shadow-glow);
            `;
            
            panel.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <div style="
                        width: 40px; 
                        height: 40px; 
                        background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
                        border-radius: 10px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin-right: 12px;
                        font-size: 18px;
                    ">ü™ü</div>
                    <div>
                        <div style="font-weight: 600; color: var(--text-primary);">–í—ã–±—Ä–∞–Ω–Ω–æ–µ –æ–∫–Ω–æ</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">—Ä–µ–∂–∏–º –æ–∫–æ–Ω–Ω–æ–≥–æ –∑–∞—Ö–≤–∞—Ç–∞</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">–ù–∞–∑–≤–∞–Ω–∏–µ:</div>
                    <div style="font-size: 14px; font-weight: 500; color: var(--accent-blue);">${windowInfo.name}</div>
                </div>
                
                ${windowInfo.executableName ? `
                <div style="margin-bottom: 10px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:</div>
                    <div style="font-size: 14px; color: var(--text-primary);">${windowInfo.executableName}</div>
                </div>
                ` : ''}
                
                <div style="
                    background: rgba(139, 92, 246, 0.1);
                    border: 1px solid rgba(139, 92, 246, 0.3);
                    border-radius: 8px;
                    padding: 12px;
                    margin-top: 15px;
                    font-size: 12px;
                    color: var(--accent-purple);
                    text-align: center;
                ">
                    üìç –û–±–ª–∞—Å—Ç–∏ –º–æ–∂–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å —Ç–æ–ª—å–∫–æ<br>–≤–Ω—É—Ç—Ä–∏ –¥–∞–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞
                </div>
            `;
            
            document.body.appendChild(panel);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            panel.style.transform = 'translateX(100%)';
            panel.style.transition = 'transform 0.3s ease-out';
            
            setTimeout(() => {
                panel.style.transform = 'translateX(0)';
            }, 100);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –æ—à–∏–±–∫–∏
        const style = document.createElement('style');
        style.textContent = `
            @keyframes errorSlide {
                from {
                    opacity: 0;
                    transform: translateX(-50%) translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
            }
        `;
        document.head.appendChild(style);

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('preview-modal').classList.contains('active')) {
                    retrySetup();
                } else {
                    cancelSetup();
                }
            }
        });
    </script>
</body>
</html>