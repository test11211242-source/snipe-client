name: Build and Publish Snipe Client

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 3.1.21)'
        required: true
        type: string

jobs:
  build-windows:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pc-build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wine
        run: |
          sudo dpkg --add-architecture i386
          sudo mkdir -pm755 /etc/apt/keyrings
          sudo wget -O /etc/apt/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.key
          sudo wget -NP /etc/apt/sources.list.d/ https://dl.winehq.org/wine-builds/ubuntu/dists/$(lsb_release -sc)/winehq-$(lsb_release -sc).sources
          sudo apt update
          sudo apt install -y --install-recommends winehq-stable

      - name: Install dependencies
        run: npm install

      - name: Build Windows installer
        run: npm run build

      - name: Create latest.yml
        run: |
          VERSION="${{ github.event.inputs.version }}"
          EXE_FILE="dist/Snipe_Client_Setup_${VERSION}.exe"

          SHA512=$(sha512sum "$EXE_FILE" | awk '{print $1}' | xxd -r -p | base64)
          FILE_SIZE=$(stat -c%s "$EXE_FILE")
          RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")

          cat > dist/latest.yml << EOF
          version: ${VERSION}
          files:
            - url: Snipe_Client_Setup_${VERSION}.exe
              sha512: ${SHA512}
              size: ${FILE_SIZE}
          path: Snipe_Client_Setup_${VERSION}.exe
          sha512: ${SHA512}
          releaseDate: '${RELEASE_DATE}'
          EOF

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Upload installer to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        shell: bash
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # Upload installer
          scp dist/Snipe_Client_Setup_${VERSION}.exe ${SERVER_USER}@${SERVER_HOST}:/home/ubuntu/snipe/data/updates/downloads/

          # Upload latest.yml
          scp dist/latest.yml ${SERVER_USER}@${SERVER_HOST}:/home/ubuntu/snipe/data/updates/downloads/

      - name: Update versions.json on server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        shell: bash
        run: |
          VERSION="${{ github.event.inputs.version }}"

          ssh ${SERVER_USER}@${SERVER_HOST} << ENDSSH
          cd /home/ubuntu/snipe/data/updates

          # Create or update versions.json
          node -e "
          const fs = require('fs');
          const version = '$VERSION';
          const versionsPath = 'versions.json';

          let data = {
            latest_version: version,
            versions: {},
            last_updated: new Date().toISOString()
          };

          if (fs.existsSync(versionsPath)) {
            data = JSON.parse(fs.readFileSync(versionsPath, 'utf-8'));
          }

          data.latest_version = version;
          data.versions[version] = {
            release_date: new Date().toISOString(),
            release_notes: 'Обновление версии ' + version,
            is_critical: false,
            changelog: ['Обновление до версии ' + version],
            installer_filename: 'Snipe_Client_Setup_' + version + '.exe',
            uploaded_by: 'github-actions'
          };
          data.last_updated = new Date().toISOString();

          fs.writeFileSync(versionsPath, JSON.stringify(data, null, 2));
          console.log('✅ versions.json updated to version ' + version);
          "
          ENDSSH

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-${{ github.event.inputs.version }}
          path: |
            dist/Snipe_Client_Setup_*.exe
            dist/latest.yml
